<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiaTech - Dashboard Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        /* Loading Screen */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-loading h2 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .auth-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ffffff33;
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .admin-container.loaded {
            opacity: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .logo {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .logo h2 {
            color: #4f46e5;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: #4f46e5;
        }

        .nav-item.active {
            background: #4f46e5;
            color: white;
        }

        .nav-item .icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .nav-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            min-width: 1rem;
            text-align: center;
            line-height: 1;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        .nav-item.active .nav-badge {
            background: rgba(255, 255, 255, 0.9);
            color: #4f46e5;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            height: 400px;
            overflow-y: auto;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 1rem;
        }

        .chart-card canvas {
            max-height: 250px;
            width: 100% !important;
        }

        .chart-content {
            max-height: 280px;
            overflow-y: auto;
        }

        .chart-card::-webkit-scrollbar {
            width: 6px;
        }

        .chart-card::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chart-card::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chart-card::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-progress {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Client Avatars */
        .client-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        /* Grid Layouts */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
        }

        /* Hidden sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animation pour le statut en ligne */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Syst√®me de Notifications */
        .notifications-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .notifications-bell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            min-width: 1.25rem;
            text-align: center;
            line-height: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .notifications-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 380px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
        }

        .notifications-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .mark-all-read {
            color: #4f46e5;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        .notification-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .notification-item:hover {
            background-color: #f8fafc;
        }

        .notification-item.high-priority {
            background-color: #fef2f2;
            border-left: 3px solid #ef4444;
        }

        .notification-item.medium-priority {
            background-color: #fffbeb;
            border-left: 3px solid #f59e0b;
        }

        .notification-icon {
            font-size: 1.25rem;
            min-width: 2rem;
            text-align: center;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .notification-description {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
        }

        .notification-count {
            background: #e2e8f0;
            color: #475569;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }

        .notification-count.has-items {
            background: #ef4444;
            color: white;
        }

        .notifications-empty {
            padding: 2rem;
            text-align: center;
            color: #64748b;
        }

        .notifications-footer {
            padding: 0.75rem 1.25rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Auth Loading Screen -->
    <div id="authLoading" class="auth-loading">
        <h2>üîê V√©rification des droits d'acc√®s...</h2>
        <div class="spinner"></div>
    </div>

    <div id="adminContainer" class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <img src="miatech-logo.svg" alt="MiaTech Logo" style="height: 60px; width: auto;">
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    <span class="icon">üìä</span>
                    Dashboard
                </button>
                <button class="nav-item" onclick="showSection('clients')">
                    <span class="icon">üë•</span>
                    Clients
                </button>
                <button class="nav-item" onclick="showSection('orders')">
                    <span class="icon">üì¶</span>
                    Commandes
                </button>
                <button class="nav-item" onclick="showSection('payments')">
                    <span class="icon">üí∞</span>
                    Paiements
                </button>
                <button class="nav-item" onclick="showSection('chat')">
                    <span class="icon">üí¨</span>
                    Messages
                    <span id="messagesBadge" class="nav-badge" style="display: none;">0</span>
                </button>
                <button class="nav-item" onclick="showSection('team')">
                    <span class="icon">üßë‚Äçüíª</span>
                    √âquipe
                </button>
                <button class="nav-item" onclick="showSection('projects')">
                    <span class="icon">üìä</span>
                    Projets
                </button>
                <button class="nav-item" onclick="showSection('quotes')">
                    <span class="icon">üìã</span>
                    Devis
                </button>
                <button class="nav-item" onclick="showSection('statistics')">
                    <span class="icon">üìà</span>
                    Statistiques
                </button>
                <button class="nav-item" onclick="showSection('settings')">
                    <span class="icon">‚öôÔ∏è</span>
                    Param√®tres
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="user-menu">
                    <!-- Syst√®me de Notifications -->
                    <div style="position: relative; margin-right: 1rem;">
                        <div class="notifications-bell" onclick="toggleNotifications()">
                            üîî
                            <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
                        </div>
                        <div id="notificationsDropdown" class="notifications-dropdown" style="display: none;">
                            <div class="notifications-header">
                                <div class="notifications-title">üì¢ Notifications</div>
                                <a class="mark-all-read" onclick="markAllAsRead()">Tout marquer comme lu</a>
                            </div>
                            <div id="notificationsList">
                                <div class="notifications-empty">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîî</div>
                                    Chargement des notifications...
                                </div>
                            </div>
                            <div class="notifications-footer">
                                <div id="lastUpdateTime">Derni√®re mise √† jour: --:--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-avatar" id="userAvatar">AA</div>
                    <span id="userName">Admin MiaTech</span>
                    <button class="logout-btn" onclick="logout()">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Clients</div>
                                <span style="color: #3b82f6;">üë•</span>
                            </div>
                            <div class="stat-value" id="totalClients">0</div>
                            <div class="stat-change positive">+12% ce mois</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Commandes</div>
                                <span style="color: #10b981;">üì¶</span>
                            </div>
                            <div class="stat-value" id="totalOrders">0</div>
                            <div class="stat-change positive">+8% ce mois</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Revenus</div>
                                <span style="color: #f59e0b;">üí∞</span>
                            </div>
                            <div class="stat-value" id="totalRevenue">$0</div>
                            <div class="stat-change positive">+23% ce mois</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Satisfaction</div>
                                <span style="color: #ef4444;">‚≠ê</span>
                            </div>
                            <div class="stat-value" id="satisfaction">92%</div>
                            <div class="stat-change positive">+2% ce mois</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">Ventes Mensuelles</div>
                            <div class="chart-content">
                                <canvas id="salesChart" height="250"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-title">Services Demand√©s</div>
                            <div class="chart-content">
                                <canvas id="servicesChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders and Clients -->
                    <div class="two-column">
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">Commandes R√©centes</div>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Service</th>
                                        <th>Client</th>
                                        <th>Statut</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="recentOrdersTable">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">Clients R√©cents</div>
                            </div>
                            <div id="recentClientsList" style="padding: 1rem;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Autres sections identiques au fichier original... -->
                <!-- Pour √©conomiser l'espace, je n'inclus que le dashboard ici -->
                <!-- Le reste est identique au fichier admin-dashboard.html -->
                
                <!-- Clients Section -->
                <div id="clients" class="section">
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Clients</div>
                                <span style="color: #3b82f6;">üë•</span>
                            </div>
                            <div class="stat-value" id="clientsTotal">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Clients Actifs</div>
                                <span style="color: #10b981;">üü¢</span>
                            </div>
                            <div class="stat-value" id="clientsActive">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Nouveaux ce mois</div>
                                <span style="color: #f59e0b;">‚≠ê</span>
                            </div>
                            <div class="stat-value" id="clientsNew">0</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üìã Liste des Clients</div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Email</th>
                                    <th>R√¥le</th>
                                    <th>Inscription</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <tr><td colspan="6" class="loading">üîÑ Chargement des clients...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders" class="section">
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Commandes</div>
                                <span style="color: #3b82f6;">üì¶</span>
                            </div>
                            <div class="stat-value" id="ordersTotal">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">En cours</div>
                                <span style="color: #f59e0b;">‚è≥</span>
                            </div>
                            <div class="stat-value" id="ordersPending">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Termin√©es</div>
                                <span style="color: #10b981;">‚úÖ</span>
                            </div>
                            <div class="stat-value" id="ordersCompleted">0</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üìã Gestion des Commandes</div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Budget</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr><td colspan="7" class="loading">üîÑ Chargement des commandes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments" class="section">
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Revenus Total</div>
                                <span style="color: #10b981;">üí∞</span>
                            </div>
                            <div class="stat-value" id="paymentsTotal">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Ce mois</div>
                                <span style="color: #3b82f6;">üìä</span>
                            </div>
                            <div class="stat-value" id="paymentsMonth">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">En attente</div>
                                <span style="color: #f59e0b;">‚è≥</span>
                            </div>
                            <div class="stat-value" id="paymentsPending">$0</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üí≥ Historique des Paiements</div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Client</th>
                                    <th>Montant</th>
                                    <th>M√©thode</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr><td colspan="6" class="loading">üîÑ Chargement des paiements...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chat Section -->
                <div id="chat" class="section">
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Messages Total</div>
                                <span style="color: #3b82f6;">üí¨</span>
                            </div>
                            <div class="stat-value" id="chatTotal">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Non lus</div>
                                <span style="color: #ef4444;">üîî</span>
                            </div>
                            <div class="stat-value" id="chatUnread">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Aujourd'hui</div>
                                <span style="color: #10b981;">üìÖ</span>
                            </div>
                            <div class="stat-value" id="chatToday">0</div>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="table-container">
                            <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="table-title">üí¨ Messages R√©cents</div>
                                <button id="markAllReadBtn" onclick="markAllMessagesAsRead()" 
                                        style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; display: none;">
                                    ‚úÖ Tout marquer lu
                                </button>
                            </div>
                            <div id="chatMessages" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
                                <div class="loading">üîÑ Chargement des messages...</div>
                            </div>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">‚ö° R√©ponse Rapide</div>
                            </div>
                            <div style="padding: 1rem;">
                                <div style="margin-bottom: 1rem;">
                                    <label for="quickReply" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Message:</label>
                                    <textarea id="quickReply" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit;" placeholder="Tapez votre r√©ponse..."></textarea>
                                </div>
                                <button onclick="sendQuickReply()" class="btn btn-primary" style="width: 100%;">
                                    üì§ Envoyer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Section -->
                <div id="team" class="section">
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total √âquipe</div>
                                <span style="color: #3b82f6;">üë•</span>
                            </div>
                            <div class="stat-value" id="teamTotal">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Administrateurs</div>
                                <span style="color: #ef4444;">üõ°Ô∏è</span>
                            </div>
                            <div class="stat-value" id="teamAdmins">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">D√©veloppeurs</div>
                                <span style="color: #10b981;">üíª</span>
                            </div>
                            <div class="stat-value" id="teamDevs">0</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üë• Gestion de l'√âquipe</div>
                            <button class="btn btn-primary" onclick="showCreateTeamMemberModal()">
                                ‚ûï Ajouter Membre
                            </button>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Membre</th>
                                    <th>Email</th>
                                    <th>R√¥le</th>
                                    <th>Statut</th>
                                    <th>Derni√®re activit√©</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody">
                                <tr><td colspan="6" class="loading">üîÑ Chargement de l'√©quipe...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="projects" class="section">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div>
                                <div class="stat-label">Projets Actifs</div>
                                <div class="stat-value" id="activeProjectsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚úÖ</div>
                            <div>
                                <div class="stat-label">Projets Termin√©s</div>
                                <div class="stat-value" id="completedProjectsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div>
                                <div class="stat-label">Revenus Totaux</div>
                                <div class="stat-value" id="projectTotalRevenue">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div>
                                <div class="stat-label">Membres Actifs</div>
                                <div class="stat-value" id="activeMembersCount">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">üìä Gestion des Projets</div>
                                <button class="btn btn-primary" onclick="showCreateProjectModal()">
                                    ‚ûï Nouveau Projet
                                </button>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Projet</th>
                                        <th>Client</th>
                                        <th>Statut</th>
                                        <th>Progr√®s</th>
                                        <th>√âquipe</th>
                                        <th>Budget</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projectsTableBody">
                                    <tr><td colspan="7" class="loading">üîÑ Chargement des projets...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">üë• Attribution d'√âquipe</div>
                            </div>
                            <div id="projectAssignmentPanel" style="padding: 1.5rem; text-align: center; color: #6b7280;">
                                üìå S√©lectionnez un projet pour voir les attributions
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quotes Section -->
                <div id="quotes" class="section">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon">üìã</div>
                            <div>
                                <div class="stat-label">Total Devis</div>
                                <div class="stat-value" id="quotesTotalCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è≥</div>
                            <div>
                                <div class="stat-label">En Attente</div>
                                <div class="stat-value" id="quotesPendingCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí¨</div>
                            <div>
                                <div class="stat-label">R√©pondus</div>
                                <div class="stat-value" id="quotesRespondedCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚úÖ</div>
                            <div>
                                <div class="stat-label">Accept√©s</div>
                                <div class="stat-value" id="quotesAcceptedCount">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üìã Devis Re√ßus</div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <select id="quotesFilter" onchange="filterQuotes()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="all">Tous les devis</option>
                                    <option value="pending">En attente de r√©ponse</option>
                                    <option value="responded">R√©pondus</option>
                                    <option value="accepted">Accept√©s</option>
                                    <option value="rejected">Rejet√©s</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Projet</th>
                                    <th>Budget</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotesTableBody">
                                <tr><td colspan="7" class="loading">üîÑ Chargement des devis...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div id="statistics" class="section">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div>
                                <div class="stat-label">Taux de R√©ussite</div>
                                <div class="stat-value" id="completionRate">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üíº</div>
                            <div>
                                <div class="stat-label">Valeur Moyenne</div>
                                <div class="stat-value" id="averageProjectValue">$0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è±Ô∏è</div>
                            <div>
                                <div class="stat-label">Projets en Attente</div>
                                <div class="stat-value" id="onHoldProjectsCount">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üíØ</div>
                            <div>
                                <div class="stat-label">Budget Total</div>
                                <div class="stat-value" id="totalBudget">$0</div>
                            </div>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">üìä Projets par Statut</div>
                            </div>
                            <div style="padding: 1.5rem;">
                                <canvas id="statusChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">üëë Performance de l'√âquipe</div>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Membre</th>
                                        <th>Projets</th>
                                        <th>Termin√©s</th>
                                        <th>R√¥les</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="teamStatsTableBody">
                                    <tr><td colspan="5" class="loading">üîÑ Chargement des stats...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">üïí Projets R√©cents</div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Projet</th>
                                    <th>Statut</th>
                                    <th>Progr√®s</th>
                                    <th>√âquipe</th>
                                    <th>Date de Cr√©ation</th>
                                </tr>
                            </thead>
                            <tbody id="recentProjectsTableBody">
                                <tr><td colspan="5" class="loading">üîÑ Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="section">
                    <div class="two-column">
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">‚öôÔ∏è Param√®tres G√©n√©raux</div>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div id="settingsAlert" class="alert" style="display: none; margin-bottom: 1rem;"></div>
                                
                                <form id="settingsForm">
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nom de l'entreprise: <span style="color: #ef4444;">*</span></label>
                                        <input type="text" id="companyName" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="Nom de votre entreprise">
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email de contact: <span style="color: #ef4444;">*</span></label>
                                        <input type="email" id="companyEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="contact@entreprise.com">
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">T√©l√©phone:</label>
                                        <input type="tel" id="companyPhone" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="+33 1 23 45 67 89">
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Adresse:</label>
                                        <input type="text" id="companyAddress" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="Adresse compl√®te">
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Site web:</label>
                                        <input type="url" id="companyWebsite" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="https://votre-site.com">
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description:</label>
                                        <textarea id="companyDescription" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit;" placeholder="Description de votre entreprise"></textarea>
                                    </div>
                                    
                                    <div style="display: flex; gap: 1rem;">
                                        <button type="button" class="btn btn-primary" id="saveSettingsBtn" onclick="window.saveSettingsBtn()">
                                            üíæ Sauvegarder
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="reloadSettings()">
                                            üîÑ Recharger
                                        </button>
                                    </div>
                                </form>
                                
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        <div><strong>Derni√®re modification:</strong> <span id="lastUpdated">-</span></div>
                                        <div><strong>Modifi√© par:</strong> Admin #<span id="updatedBy">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">üìä Statistiques Syst√®me</div>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #374151;">Serveur</div>
                                    <div style="color: #10b981; font-size: 0.9rem;">üü¢ En ligne</div>
                                </div>
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #374151;">Base de donn√©es</div>
                                    <div style="color: #10b981; font-size: 0.9rem;">üü¢ Connect√©e</div>
                                </div>
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #374151;">Version</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">v1.0.0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour cr√©er un nouveau projet -->
    <div id="createProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üìä Nouveau Projet</h3>
            
            <form id="createProjectForm">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Titre du projet</label>
                    <input type="text" id="projectTitle" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Description</label>
                    <textarea id="projectDescription" required rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Client</label>
                        <select id="projectClient" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">S√©lectionner un client</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Budget ($)</label>
                        <input type="number" id="projectBudget" min="0" step="100" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Date limite</label>
                        <input type="date" id="projectDeadline" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Priorit√©</label>
                        <select id="projectPriority" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="low">üü¢ Basse</option>
                            <option value="medium" selected>üü° Moyenne</option>
                            <option value="high">üî¥ Haute</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" onclick="closeCreateProjectModal()" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 4px; cursor: pointer;">Annuler</button>
                    <button type="submit" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 4px; cursor: pointer;">Cr√©er le Projet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let dashboardData = {};
        let adminUser = null;

        // Initialize authentication check
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Check if user is authenticated
        async function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            const userData = localStorage.getItem('adminUser');
            
            if (!token || !userData) {
                redirectToLogin();
                return;
            }
            
            try {
                // Verify token with server
                const response = await fetch('/api/admin/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Token invalide');
                }
                
                // Parse user data
                adminUser = JSON.parse(userData);
                
                // Update UI with user info
                updateUserInfo();
                
                // Hide loading and show dashboard
                document.getElementById('authLoading').style.display = 'none';
                document.getElementById('adminContainer').classList.add('loaded');
                
                // Load dashboard data
                loadDashboardData();
                initCharts();
                
                // Initialiser le syst√®me de notifications
                initNotifications();
                
            } catch (error) {
                console.error('Erreur authentification:', error);
                redirectToLogin();
            }
        }

        // Update user info in header
        function updateUserInfo() {
            if (!adminUser) return;
            
            document.getElementById('userName').textContent = adminUser.name;
            
            const initials = adminUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userAvatar').textContent = initials;
        }

        // Redirect to login page
        function redirectToLogin() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = '/admin-login';
        }

        // Logout function
        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/admin-login';
            }
        }

        // Navigation function
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'clients': 'Gestion des Clients',
                'orders': 'Gestion des Commandes', 
                'payments': 'Gestion des Paiements',
                'chat': 'Messages & Chat',
                'team': 'Gestion de l\'√âquipe',
                'projects': 'Gestion des Projets',
                'statistics': 'Statistiques & Analyses',
                'settings': 'Param√®tres'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            
            currentSection = section;
            
            // Load section specific data
            loadSectionData(section);
        }

        // Load section specific data
        async function loadSectionData(section) {
            const token = localStorage.getItem('adminToken');
            
            switch(section) {
                case 'clients':
                    await loadClientsData(token);
                    break;
                case 'orders':
                    await loadOrdersData(token);
                    break;
                case 'payments':
                    await loadPaymentsData(token);
                    break;
                case 'chat':
                    await loadChatData(token);
                    break;
                case 'team':
                    await loadTeamData(token);
                    break;
                case 'projects':
                    await loadProjectsData(token);
                    break;
                case 'statistics':
                    await loadStatisticsData(token);
                    break;
                case 'settings':
                    console.log('üìã Chargement section param√®tres');
                    await loadSettingsData(token);
                    break;
                case 'quotes':
                    await loadQuotesData(token);
                    break;
            }
        }

        // Load dashboard data with authentication - UTILISE LES M√äMES DONN√âES QUE GESTION CLIENTS
        async function loadDashboardData() {
            const token = localStorage.getItem('adminToken');
            
            try {
                const [clientsRes, ordersRes, paymentsRes] = await Promise.all([
                    fetch('/api/admin/all-clients', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/orders', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/payments', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const clientsData = await clientsRes.json();
                const orders = await ordersRes.json();
                const payments = await paymentsRes.json();

                // Utiliser les vraies stats clients (identiques √† la gestion clients)
                const stats = clientsData.stats || {};
                const clients = clientsData.clients || [];
                
                // Update stats avec les M√äMES donn√©es que la gestion clients
                document.getElementById('totalClients').textContent = stats.totalClients || 0;
                document.getElementById('totalOrders').textContent = stats.totalOrders || 0;
                document.getElementById('totalRevenue').textContent = `$${payments.totalAmount || 0}`;
                
                // Load recent data avec les vrais clients
                loadRecentOrders(orders.orders || []);
                loadRecentClients(clients);
                
                dashboardData = { clients, orders, payments, stats };
                
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
            }
        }

        // Load recent orders
        function loadRecentOrders(orders) {
            const tbody = document.getElementById('recentOrdersTable');
            const recentOrders = orders.slice(-5).reverse();
            
            tbody.innerHTML = recentOrders.map(order => `
                <tr>
                    <td>#${order.id}</td>
                    <td>${order.serviceId}</td>
                    <td>Client #${order.userId}</td>
                    <td><span class="status-badge status-${order.status === 'pending' ? 'pending' : order.status === 'paid' ? 'progress' : 'completed'}">${order.status}</span></td>
                    <td>$${order.budget || '0'}</td>
                </tr>
            `).join('');
        }

        // Load recent clients - IDENTIQUE aux donn√©es de gestion clients
        function loadRecentClients(clients) {
            const container = document.getElementById('recentClientsList');
            // Filtrer seulement les vrais clients (pas les admins) et prendre les 5 derniers
            const recentClients = clients
                .filter(client => client.role === 'client')
                .slice(-5).reverse();
            
            console.log('üìã Clients r√©cents affich√©s:', recentClients.length);
            
            container.innerHTML = recentClients.map(client => {
                const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                const color = client.isOnline ? '#10b981' : colors[client.id ? String(client.id).slice(-1) % colors.length : 0];
                
                return `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9;">
                        <div class="client-avatar" style="background: ${color}; position: relative;">${initials}
                            ${client.isOnline ? '<div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #22c55e; border: 1px solid white; border-radius: 50%;"></div>' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${client.name} ${client.isOnline ? 'üü¢' : ''}</div>
                            <div style="font-size: 0.875rem; color: #64748b;">${client.email}</div>
                            <div style="font-size: 0.75rem; color: #94a3b8;">
                                ${client.orderCount || 0} commandes ‚Ä¢ ${client.messageCount || 0} messages
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize charts
        function initCharts() {
            // Sales Chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Ventes ($)',
                        data: [15000, 22000, 18000, 32000, 28000, 35000],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Services Chart
            const servicesCtx = document.getElementById('servicesChart').getContext('2d');
            new Chart(servicesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Application', 'UI/UX', 'Branding'],
                    datasets: [{
                        data: [45, 30, 25],
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load clients data (ALL clients with real connection status)
        async function loadClientsData(token) {
            try {
                const response = await fetch('/api/admin/all-clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const clients = data.clients || [];
                    const stats = data.stats || {};
                    
                    console.log('üë• Clients r√©cup√©r√©s:', clients.length, 'En ligne:', stats.onlineClients);
                    
                    // Update stats avec les donn√©es du serveur
                    document.getElementById('clientsTotal').textContent = stats.totalClients || 0;
                    document.getElementById('clientsActive').textContent = stats.onlineClients || 0;
                    document.getElementById('clientsNew').textContent = stats.todayActive || 0;
                    
                    // Update table
                    const tbody = document.getElementById('clientsTableBody');
                    if (clients.length > 0) {
                        tbody.innerHTML = clients.map(client => {
                            const lastSeenTime = new Date(client.lastSeen || client.lastActivity);
                            const timeDiff = Date.now() - lastSeenTime.getTime();
                            const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                            const timeDisplay = client.isOnline ? 
                                (minutesAgo < 1 ? 'Maintenant' : minutesAgo < 60 ? `Il y a ${minutesAgo}min` : `Il y a ${Math.floor(minutesAgo/60)}h`) :
                                lastSeenTime.toLocaleDateString();
                            
                            return `
                                <tr style="background: ${client.isOnline ? '#f0fdf4' : 'white'}; border-left: 4px solid ${client.isOnline ? '#10b981' : '#e5e7eb'};">
                                    <td>
                                        <div style="display: flex; align-items: center;">
                                            <div class="client-avatar" style="background: ${client.isOnline ? '#10b981' : '#6b7280'}; margin-right: 0.75rem; position: relative;">
                                                ${client.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                                ${client.isOnline ? '<div style="position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background: #22c55e; border: 2px solid white; border-radius: 50%;"></div>' : ''}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${client.name}</div>
                                                <div style="font-size: 0.875rem; color: #6b7280;">
                                                    ID: ${client.id} ‚Ä¢ üìä ${client.messageCount || 0} msgs ‚Ä¢ üîÑ ${client.connectionCount || 0} connexions
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>${client.email}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">${client.userAgent || 'Navigateur inconnu'}</div>
                                    </td>
                                    <td><span class="status-badge status-progress">${client.role}</span></td>
                                    <td>
                                        <div style="font-size: 0.875rem;">${timeDisplay}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">Cr√©√©: ${new Date(client.createdAt || Date.now()).toLocaleDateString()}</div>
                                    </td>
                                    <td>
                                        <span class="status-badge ${client.isOnline ? 'status-completed' : 'status-pending'}" style="display: flex; align-items: center; gap: 0.5rem;">
                                            ${client.isOnline ? 'üü¢ En ligne' : '‚ö™ Hors ligne'}
                                            ${client.isOnline ? '<div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></div>' : ''}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="viewClient('${client.id}')">üëÅÔ∏è Voir</button>
                                        ${client.isOnline ? '<button class="btn btn-primary" onclick="startChat(\'' + client.id + '\')">üí¨ Chat</button>' : ''}
                                        <button class="btn" onclick="deleteClient('${client.id}', '${client.name}')" style="background: #dc2626; color: white; margin-left: 0.5rem;" title="Supprimer le client">üóëÔ∏è Suppr</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280; padding: 2rem;">üì≠ Aucun client connect√©</td></tr>';
                    }
                } else {
                    console.error('Erreur API:', data.message);
                }
            } catch (error) {
                console.error('Erreur chargement clients:', error);
                document.getElementById('clientsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444; padding: 2rem;">‚ùå Erreur de chargement</td></tr>';
            }
        }

        // Load orders data
        async function loadOrdersData(token) {
            try {
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Update stats
                document.getElementById('ordersTotal').textContent = data.count || 0;
                document.getElementById('ordersPending').textContent = data.orders?.filter(o => o.status === 'pending').length || 0;
                document.getElementById('ordersCompleted').textContent = data.orders?.filter(o => o.status === 'completed').length || 0;
                
                // Update table
                const tbody = document.getElementById('ordersTableBody');
                if (data.orders && data.orders.length > 0) {
                    tbody.innerHTML = data.orders.map(order => `
                        <tr>
                            <td>#${order.id}</td>
                            <td>Client #${order.userId}</td>
                            <td>${order.serviceId || 'Service personnalis√©'}</td>
                            <td>$${order.budget || '0'}</td>
                            <td><span class="status-badge status-${order.status === 'pending' ? 'pending' : order.status === 'completed' ? 'completed' : 'progress'}">${order.status}</span></td>
                            <td>${new Date(order.createdAt || Date.now()).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewOrder(${order.id})">üëÅÔ∏è Voir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">Aucune commande trouv√©e</td></tr>';
                }
            } catch (error) {
                console.error('Erreur chargement commandes:', error);
            }
        }

        // Load payments data
        async function loadPaymentsData(token) {
            try {
                const response = await fetch('/api/admin/payments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Update stats
                const totalAmount = data.payments?.reduce((sum, p) => sum + (p.amount || 0), 0) || 0;
                document.getElementById('paymentsTotal').textContent = `$${totalAmount}`;
                document.getElementById('paymentsMonth').textContent = `$${Math.floor(totalAmount * 0.3)}`; // Mock
                document.getElementById('paymentsPending').textContent = `$${Math.floor(totalAmount * 0.1)}`; // Mock
                
                // Update table
                const tbody = document.getElementById('paymentsTableBody');
                if (data.payments && data.payments.length > 0) {
                    tbody.innerHTML = data.payments.map(payment => `
                        <tr>
                            <td>#${payment.id}</td>
                            <td>Client #${payment.userId}</td>
                            <td>$${payment.amount}</td>
                            <td>${payment.method || 'Carte'}</td>
                            <td><span class="status-badge status-${payment.status === 'paid' ? 'completed' : 'pending'}">${payment.status}</span></td>
                            <td>${new Date(payment.createdAt || Date.now()).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">Aucun paiement trouv√©</td></tr>';
                }
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
            }
        }

        // Load chat data
        async function loadChatData(token) {
            try {
                const response = await fetch('/api/chat/messages', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Update stats
                const unreadMessages = data.messages?.filter(m => !m.isRead) || [];
                document.getElementById('chatTotal').textContent = data.count || 0;
                document.getElementById('chatUnread').textContent = unreadMessages.length;
                document.getElementById('chatToday').textContent = data.messages?.filter(m => {
                    const today = new Date().toDateString();
                    return new Date(m.timestamp).toDateString() === today;
                }).length || 0;
                
                // Afficher/masquer le bouton "Tout marquer comme lu"
                const markAllBtn = document.getElementById('markAllReadBtn');
                if (markAllBtn) {
                    markAllBtn.style.display = unreadMessages.length > 0 ? 'block' : 'none';
                }
                
                // Mettre √† jour le badge de la sidebar
                updateSidebarMessagesBadge(unreadMessages.length);
                
                // Update messages
                const container = document.getElementById('chatMessages');
                if (data.messages && data.messages.length > 0) {
                    console.log('üí¨ Messages re√ßus:', data.messages);
                    
                    container.innerHTML = data.messages.slice(-10).reverse().map(msg => {
                        // Utiliser le bon champ pour le contenu du message
                        const messageContent = msg.message || msg.content || 'Message vide';
                        const senderName = msg.senderName || `Utilisateur #${msg.senderId}`;
                        const senderRole = msg.senderRole || 'client';
                        const timestamp = msg.timestamp || new Date().toISOString();
                        
                        console.log('üìù Message:', {
                            content: messageContent,
                            sender: senderName,
                            role: senderRole,
                            time: timestamp
                        });
                        
                        return `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: ${senderRole === 'admin' ? '#f0f9ff' : '#fef3c7'}; border-radius: 8px; border-left: 4px solid ${senderRole === 'admin' ? '#3b82f6' : '#f59e0b'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-weight: 600; color: #374151;">
                                        ${senderRole === 'admin' ? 'üõ°Ô∏è' : 'üë§'} ${senderName} 
                                        <span style="font-size: 0.8rem; color: #6b7280;">(${senderRole})</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">${new Date(timestamp).toLocaleString()}</div>
                                </div>
                                <div style="color: #374151; background: white; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                                    "${messageContent}"
                                </div>
                                ${!msg.isRead ? '<div style="color: #ef4444; font-size: 0.75rem; margin-top: 0.5rem; font-weight: 600;">üîî Nouveau message</div>' : ''}
                                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                    <button onclick="replyToMessage('${msg.id}', '${senderName}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                                        üí¨ R√©pondre
                                    </button>
                                    ${!msg.isRead ? `<button onclick="markMessageAsRead('${msg.id}')" style="background: #10b981; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">‚úÖ Marquer lu</button>` : '<span style="color: #10b981; font-size: 0.8rem;">‚úì Lu</span>'}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">üì≠ Aucun message trouv√©</div>';
                }
            } catch (error) {
                console.error('Erreur chargement chat:', error);
            }
        }

        // Load team data (only admin roles)
        async function loadTeamData(token) {
            try {
                const response = await fetch('/api/admin/team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const admins = data.members || [];
                    const adminsOnline = admins.filter(a => a.isOnline);
                    const superAdmins = admins.filter(a => a.role === 'super_admin');
                    const devs = admins.filter(a => a.role === 'dev');
                    const designers = admins.filter(a => a.role === 'designer');
                    
                    // Update stats
                    document.getElementById('teamTotal').textContent = admins.length;
                    document.getElementById('teamAdmins').textContent = admins.filter(a => a.role.includes('admin')).length;
                    document.getElementById('teamDevs').textContent = devs.length + designers.length;
                    
                    // Update table
                    const tbody = document.getElementById('teamTableBody');
                    if (admins.length > 0) {
                        tbody.innerHTML = admins.map(admin => {
                            const roleColor = {
                                'super_admin': '#dc2626',
                                'admin': '#ea580c', 
                                'dev': '#2563eb',
                                'designer': '#7c3aed'
                            };
                            
                            const roleEmoji = {
                                'super_admin': 'üëë',
                                'admin': 'üõ°Ô∏è',
                                'dev': 'üíª',
                                'designer': 'üé®'
                            };
                            
                            return `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center;">
                                            <div class="client-avatar" style="background: ${roleColor[admin.role] || '#6b7280'}; margin-right: 0.75rem;">
                                                ${roleEmoji[admin.role] || admin.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${admin.name}</div>
                                                <div style="font-size: 0.875rem; color: #6b7280;">ID: ${admin.id}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${admin.email}</td>
                                    <td><span class="status-badge status-completed" style="background: ${roleColor[admin.role] || '#6b7280'}; color: white;">${admin.role}</span></td>
                                    <td>
                                        <span class="status-badge ${admin.isOnline ? 'status-completed' : 'status-pending'}">
                                            ${admin.isOnline ? 'üü¢ En ligne' : '‚ö™ Hors ligne'}
                                        </span>
                                    </td>
                                    <td>${new Date(admin.lastSeen).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editTeamMember('${admin.id}')">‚úèÔ∏è Modifier</button>
                                        ${admin.isOnline ? '<button class="btn btn-primary" onclick="contactAdmin(\'' + admin.id + '\')">üìû Contact</button>' : ''}
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280; padding: 2rem;">üë• Aucun membre d\'√©quipe connect√©</td></tr>';
                    }
                } else {
                    console.error('Erreur API √©quipe:', data.message);
                }
            } catch (error) {
                console.error('Erreur chargement √©quipe:', error);
                document.getElementById('teamTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444; padding: 2rem;">‚ùå Erreur de chargement</td></tr>';
            }
        }

        // Action functions
        function viewClient(id) {
            alert(`Voir d√©tails du client ID: ${id}`);
        }

        function startChat(clientId) {
            // Basculer vers la section chat et pr√©-s√©lectionner le client
            showSection('chat');
            alert(`üí¨ Chat avec le client ${clientId} - Fonctionnalit√© √† d√©velopper`);
        }

        function viewOrder(id) {
            alert(`Voir d√©tails de la commande ID: ${id}`);
        }

        function editTeamMember(id) {
            alert(`‚úèÔ∏è Modifier membre √©quipe ID: ${id} - Fonctionnalit√© √† d√©velopper`);
        }

        // Fonction pour afficher le modal de cr√©ation de membre d'√©quipe
        function showCreateTeamMemberModal() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üë• Nouveau Membre d'√âquipe</h3>
                        
                        <form id="createTeamMemberForm">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üë§ Nom complet</label>
                                <input type="text" id="memberName" placeholder="Ex: John Doe" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìß Email</label>
                                <input type="email" id="memberEmail" placeholder="Ex: john@miatech.com" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üîí Mot de passe</label>
                                <input type="password" id="memberPassword" placeholder="Minimum 6 caract√®res" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üì± T√©l√©phone (optionnel)</label>
                                <input type="tel" id="memberPhone" placeholder="Ex: +33 1 23 45 67 89" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üõ°Ô∏è R√¥le</label>
                                <select id="memberRole" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">S√©lectionner un r√¥le</option>
                                    <option value="admin">üõ°Ô∏è Administrateur</option>
                                    <option value="dev">üíª D√©veloppeur</option>
                                    <option value="designer">üé® Designer</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeCreateTeamMemberModal()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px;">Annuler</button>
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px;">‚úÖ Cr√©er Membre</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('createTeamMemberForm').onsubmit = async (e) => {
                e.preventDefault();
                await createTeamMember();
            };
        }

        async function createTeamMember() {
            try {
                const memberData = {
                    name: document.getElementById('memberName').value,
                    email: document.getElementById('memberEmail').value,
                    password: document.getElementById('memberPassword').value,
                    phone: document.getElementById('memberPhone').value,
                    role: document.getElementById('memberRole').value
                };

                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(memberData)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert(`‚úÖ Membre d'√©quipe cr√©√© avec succ√®s: ${memberData.name}`);
                    closeCreateTeamMemberModal();
                    
                    // Recharger les donn√©es de l'√©quipe
                    await loadTeamData(token);
                } else {
                    alert('‚ùå Erreur lors de la cr√©ation: ' + (result.message || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la cr√©ation du membre');
            }
        }

        function closeCreateTeamMemberModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function contactAdmin(adminId) {
            alert(`üìû Contacter l'admin ${adminId} - Fonctionnalit√© √† d√©velopper`);
        }
        
        // Supprimer un client
        async function deleteClient(clientId, clientName) {
            // Confirmation de suppression
            const confirmMessage = `‚ö†Ô∏è ATTENTION !\n\n√ätes-vous s√ªr de vouloir supprimer d√©finitivement le client :\n"${clientName}" (ID: ${clientId}) ?\n\n‚ùå Cette action supprimera :\n- Le client de la plateforme\n- Tous ses messages\n- Son historique (commandes, paiements)\n\nüö® Cette action est IRR√âVERSIBLE !`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation pour s√©curit√©
            const finalConfirm = prompt(`Pour confirmer la suppression du client "${clientName}", tapez "SUPPRIMER" en majuscules :`);
            if (finalConfirm !== 'SUPPRIMER') {
                alert('‚ùå Suppression annul√©e - Confirmation incorrecte');
                return;
            }
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                alert('Session expir√©e. Reconnectez-vous.');
                return;
            }
            
            try {
                // Afficher un indicateur de chargement
                const loadingMsg = document.createElement('div');
                loadingMsg.innerHTML = 'üîÑ Suppression en cours...';
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1rem 2rem; border: 2px solid #dc2626; border-radius: 8px; z-index: 1000; font-weight: bold; color: #dc2626;';
                document.body.appendChild(loadingMsg);
                
                const response = await fetch(`/api/admin/clients/${clientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                document.body.removeChild(loadingMsg);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Afficher un rapport d√©taill√© de suppression
                    const report = result.report || {};
                    const rapportMessage = `üóëÔ∏è SUPPRESSION D√âFINITIVE TERMIN√âE\n\n` +
                        `üë§ Client : "${report.clientName || clientName}"\n` +
                        `‚è∞ Heure : ${new Date(report.timestamp).toLocaleString()}\n\n` +
                        `üìä DONN√âES SUPPRIM√âES D√âFINITIVEMENT :\n` +
                        `üí¨ Messages : ${report.messagesDeleted || 0}\n` +
                        `üì¶ Commandes : ${report.ordersDeleted || 0}\n` +
                        `üí≥ Paiements : ${report.paymentsDeleted || 0}\n` +
                        `üìÑ Devis : ${report.quotesDeleted || 0}\n\n` +
                        `üî¢ Total √©l√©ments effac√©s : ${report.totalDataDeleted || 0}\n\n` +
                        `üîí STATUT : Suppression permanente de la base de donn√©es\n` +
                        `‚ùå Aucune r√©cup√©ration possible\n\n` +
                        `‚úÖ Le client n'existe plus sur le serveur`;
                    
                    alert(rapportMessage);
                    
                    // Recharger la liste des clients
                    loadClientsData(token);
                } else {
                    alert(`‚ùå Erreur lors de la suppression :\n${result.message || 'Erreur inconnue'}`);
                }
                
            } catch (error) {
                // Retirer le message de chargement en cas d'erreur
                const loadingElement = document.querySelector('div[style*="Suppression en cours"]');
                if (loadingElement) {
                    document.body.removeChild(loadingElement);
                }
                
                console.error('Erreur suppression client:', error);
                alert('‚ùå Erreur de connexion lors de la suppression');
            }
        }

        // Envoyer une r√©ponse rapide
        async function sendQuickReply() {
            const message = document.getElementById('quickReply').value.trim();
            if (!message) {
                alert('Veuillez saisir un message');
                return;
            }
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                alert('Session expir√©e. Reconnectez-vous.');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        isAdmin: true
                    })
                });
                
                if (response.ok) {
                    document.getElementById('quickReply').value = '';
                    alert('‚úÖ R√©ponse envoy√©e !');
                    // Recharger les messages
                    loadChatData();
                } else {
                    alert('‚ùå Erreur lors de l\'envoi');
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                alert('‚ùå Erreur de connexion');
            }
        }
        
        // R√©pondre √† un message sp√©cifique
        function replyToMessage(messageId, senderName) {
            const quickReply = document.getElementById('quickReply');
            if (quickReply) {
                quickReply.focus();
                quickReply.placeholder = `R√©pondre √† ${senderName}...`;
                // Optionnel: pr√©fixer la r√©ponse
                // quickReply.value = `@${senderName} `;
            }
        }
        
        // Marquer un message comme lu
        async function markAsRead(messageId) {
            const token = localStorage.getItem('adminToken');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/admin/messages/${messageId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('‚úÖ Message marqu√© comme lu');
                    loadChatData(); // Recharger les messages
                    updateMessagesBadge(); // Mettre √† jour le badge
                }
            } catch (error) {
                console.error('Erreur marquage lu:', error);
            }
        }

        // Nouvelle fonction pour marquer un message sp√©cifique comme lu
        async function markMessageAsRead(messageId) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                alert('‚ùå Session expir√©e. Veuillez vous reconnecter.');
                return;
            }
            
            try {
                console.log('üìß Marquage message comme lu:', messageId);
                
                const response = await fetch(`/api/admin/messages/${messageId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Message marqu√© comme lu avec succ√®s');
                    // Recharger imm√©diatement les donn√©es
                    await loadChatData(token);
                    await updateMessagesBadge();
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('‚ùå Erreur marquage message lu:', error);
                alert('‚ùå Erreur lors du marquage: ' + error.message);
            }
        }

        // Mettre √† jour le badge des messages
        async function updateMessagesBadge() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;
                
                const response = await fetch('/api/chat/messages', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const unreadCount = data.messages?.filter(m => !m.isRead).length || 0;
                
                const badge = document.getElementById('messagesBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                console.log('üîî Badge messages mis √† jour:', unreadCount);
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour badge:', error);
            }
        }

        // Mettre √† jour le badge des messages dans la sidebar
        function updateSidebarMessagesBadge(unreadCount) {
            const badge = document.getElementById('messagesBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Marquer tous les messages comme lus
        async function markAllMessagesAsRead() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                alert('‚ùå Session expir√©e. Veuillez vous reconnecter.');
                return;
            }
            
            if (!confirm('üìß √ätes-vous s√ªr de vouloir marquer tous les messages comme lus ?')) {
                return;
            }
            
            try {
                console.log('üìß Marquage de tous les messages comme lus...');
                
                const response = await fetch('/api/admin/messages/read-all', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Tous les messages marqu√©s comme lus:', data.count);
                    alert(`‚úÖ ${data.message}`);
                    
                    // Recharger imm√©diatement les donn√©es
                    await loadChatData(token);
                    await updateMessagesBadge();
                    
                    // Rafra√Æchir aussi les notifications globales
                    if (typeof loadNotifications === 'function') {
                        loadNotifications();
                    }
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('‚ùå Erreur marquage tous messages lus:', error);
                alert('‚ùå Erreur lors du marquage: ' + error.message);
            }
        }

        // Load settings data
        async function loadSettingsData(token) {
            if (!token) token = localStorage.getItem('adminToken');
            
            console.log('üîÑ Rechargement des param√®tres...');
            
            if (!token) {
                console.error('‚ùå Pas de token pour charger les param√®tres');
                showSettingsAlert('‚ùå Session expir√©e. Veuillez vous reconnecter.', 'error');
                return;
            }
            
            try {
                showSettingsAlert('üîÑ Chargement des param√®tres...', 'info');
                
                console.log('üåê Appel API settings...');
                const response = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('üì® R√©ponse re√ßue:', response.status);
                const data = await response.json();
                console.log('üìÑ Donn√©es:', data);
                
                if (response.ok && data && data.success && data.settings) {
                    const settings = data.settings;
                    
                    console.log('üìã Settings re√ßus:', settings);
                    
                    // V√©rifier que les √©l√©ments existent avant de les remplir
                    const elements = {
                        companyName: document.getElementById('companyName'),
                        companyEmail: document.getElementById('companyEmail'),
                        companyPhone: document.getElementById('companyPhone'),
                        companyAddress: document.getElementById('companyAddress'),
                        companyWebsite: document.getElementById('companyWebsite'),
                        companyDescription: document.getElementById('companyDescription')
                    };
                    
                    let missingElements = [];
                    Object.keys(elements).forEach(key => {
                        if (!elements[key]) {
                            missingElements.push(key);
                        }
                    });
                    
                    if (missingElements.length > 0) {
                        console.error('‚ùå √âl√©ments manquants:', missingElements);
                        showSettingsAlert('Erreur: Formulaire non disponible', 'error');
                        return;
                    }
                    
                    // Populate form fields avec validation
                    elements.companyName.value = String(settings.name || '');
                    elements.companyEmail.value = String(settings.email || '');
                    elements.companyPhone.value = String(settings.phone || '');
                    elements.companyAddress.value = String(settings.address || '');
                    elements.companyWebsite.value = String(settings.website || '');
                    elements.companyDescription.value = String(settings.description || '');
                    
                    // Update metadata
                    const lastUpdatedEl = document.getElementById('lastUpdated');
                    const updatedByEl = document.getElementById('updatedBy');
                    
                    if (lastUpdatedEl) {
                        const lastUpdated = settings.updatedAt ? 
                            new Date(settings.updatedAt).toLocaleString() : 'Jamais';
                        lastUpdatedEl.textContent = lastUpdated;
                    }
                    
                    if (updatedByEl) {
                        updatedByEl.textContent = String(settings.updatedBy || 'Syst√®me');
                    }
                    
                    showSettingsAlert('Param√®tres recharg√©s avec succ√®s !', 'success');
                    console.log('‚úÖ Param√®tres charg√©s:', settings);
                    
                } else {
                    const errorMsg = (data && data.message) ? data.message : 'Erreur lors du chargement';
                    console.log('‚ùå Erreur chargement:', errorMsg);
                    showSettingsAlert(errorMsg, 'error');
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement param√®tres:', error);
                showSettingsAlert(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Fonctions publiques pour les boutons
        window.reloadSettings = function() {
            console.log('üîÑ Bouton recharger cliqu√©');
            loadSettingsData();
        };
        
        window.saveSettingsBtn = async function() {
            console.log('üíæ Bouton sauvegarder cliqu√© (global)');
            await saveSettings();
        };
        
        // Fonction de test pour debug
        window.testAlert = function() {
            console.log('üß™ Test alert');
            showSettingsAlert('Test de message', 'info');
        };
        
        // Fonction de diagnostic
        window.diagnoseSettings = function() {
            console.log('üîç Diagnostic des param√®tres');
            const elements = [
                'companyName', 'companyEmail', 'companyPhone', 
                'companyAddress', 'companyWebsite', 'companyDescription',
                'settingsAlert', 'lastUpdated', 'updatedBy', 'saveSettingsBtn'
            ];
            
            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`Element ${id}:`, el ? '‚úÖ Trouv√©' : '‚ùå Manquant');
            });
            
            const token = localStorage.getItem('adminToken');
            console.log('Token admin:', token ? '‚úÖ Pr√©sent' : '‚ùå Manquant');
        };

        // Save settings data
        async function saveSettingsData(formData) {
            const token = localStorage.getItem('adminToken');
            
            console.log('üîë Token trouv√©:', !!token);
            console.log('üì§ Envoi donn√©es:', formData);
            
            if (!token) {
                showSettingsAlert('‚ùå Session expir√©e. Veuillez vous reconnecter.', 'error');
                return;
            }
            
            try {
                showSettingsAlert('üíæ Sauvegarde en cours...', 'info');
                document.getElementById('saveSettingsBtn').disabled = true;
                document.getElementById('saveSettingsBtn').innerHTML = '‚è≥ Sauvegarde...';
                
                console.log('üåê Envoi requ√™te API...');
                
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('üì® R√©ponse re√ßue:', response.status);
                
                const data = await response.json();
                console.log('üìÑ Donn√©es r√©ponse:', data);
                
                if (response.ok && data && data.success) {
                    showSettingsAlert('‚úÖ Param√®tres sauvegard√©s avec succ√®s !', 'success');
                    
                    // Update metadata
                    if (data.settings) {
                        const lastUpdatedEl = document.getElementById('lastUpdated');
                        const updatedByEl = document.getElementById('updatedBy');
                        
                        if (lastUpdatedEl) {
                            lastUpdatedEl.textContent = new Date(data.settings.updatedAt).toLocaleString();
                        }
                        if (updatedByEl) {
                            updatedByEl.textContent = String(data.settings.updatedBy || 'Syst√®me');
                        }
                    }
                    
                    console.log('‚úÖ Param√®tres sauvegard√©s:', data.settings);
                } else {
                    const errorMessage = (data && data.message) ? data.message : 'Erreur inconnue';
                    console.log('‚ùå Erreur API:', errorMessage);
                    showSettingsAlert(`‚ùå ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde:', error);
                showSettingsAlert(`‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                document.getElementById('saveSettingsBtn').disabled = false;
                document.getElementById('saveSettingsBtn').innerHTML = 'üíæ Sauvegarder';
            }
        }

        // Show settings alert
        function showSettingsAlert(message, type) {
            console.log('üö® Alert:', type, message);
            
            const alert = document.getElementById('settingsAlert');
            if (!alert) {
                console.error('‚ùå √âl√©ment settingsAlert non trouv√©');
                // Fallback avec alert navigateur
                window.alert(`[${type.toUpperCase()}] ${message || 'Message vide'}`);
                return;
            }
            
            // Nettoyer et valider le message
            const cleanMessage = String(message || 'Message non d√©fini');
            const cleanType = type || 'info';
            
            alert.className = `alert alert-${cleanType}`;
            alert.textContent = cleanMessage;
            alert.style.display = 'block';
            
            console.log('‚úÖ Alert affich√©:', cleanMessage);
            
            // Auto hide success messages
            if (cleanType === 'success' || cleanType === 'info') {
                setTimeout(() => {
                    if (alert) {
                        alert.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // Direct save function for button click
        async function saveSettings() {
            console.log('üîß Bouton sauvegarde cliqu√©');
            
            // V√©rifier que les √©l√©ments existent
            const nameEl = document.getElementById('companyName');
            const emailEl = document.getElementById('companyEmail');
            
            if (!nameEl || !emailEl) {
                console.error('‚ùå √âl√©ments du formulaire non trouv√©s');
                alert('Erreur: Formulaire non disponible. Rechargez la page.');
                return;
            }
            
            const formData = {
                name: nameEl.value.trim(),
                email: emailEl.value.trim(),
                phone: (document.getElementById('companyPhone')?.value || '').trim(),
                address: (document.getElementById('companyAddress')?.value || '').trim(),
                website: (document.getElementById('companyWebsite')?.value || '').trim(),
                description: (document.getElementById('companyDescription')?.value || '').trim()
            };
            
            console.log('üìù Donn√©es √† sauvegarder:', formData);
            
            // Basic validation
            if (!formData.name) {
                showSettingsAlert('‚ùå Le nom de l\'entreprise est obligatoire', 'error');
                return;
            }
            
            if (!formData.email) {
                showSettingsAlert('‚ùå L\'email est obligatoire', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                showSettingsAlert('‚ùå Format email invalide', 'error');
                return;
            }
            
            await saveSettingsData(formData);
        }

        // ========================
        // FONCTIONS GESTION PROJETS ET STATISTIQUES
        // ========================

        // Load projects data
        async function loadProjectsData(token) {
            try {
                const response = await fetch('/api/admin/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update stats
                    document.getElementById('activeProjectsCount').textContent = data.statistics.activeProjects || 0;
                    document.getElementById('completedProjectsCount').textContent = data.statistics.projectsCompleted || 0;
                    document.getElementById('projectTotalRevenue').textContent = `$${data.statistics.totalRevenue.toLocaleString()}`;
                    
                    // Count unique team members
                    const uniqueMembers = new Set();
                    data.projects.forEach(project => {
                        project.team.forEach(member => uniqueMembers.add(member.userId));
                    });
                    document.getElementById('activeMembersCount').textContent = uniqueMembers.size;

                    // Update projects table
                    const tbody = document.getElementById('projectsTableBody');
                    if (data.projects.length > 0) {
                        tbody.innerHTML = data.projects.map(project => {
                            const statusColors = {
                                'planning': '#3b82f6',
                                'development': '#f59e0b',
                                'testing': '#8b5cf6',
                                'review': '#06b6d4',
                                'completed': '#10b981',
                                'delivered': '#059669',
                                'on-hold': '#6b7280',
                                'cancelled': '#ef4444'
                            };
                            
                            const statusEmojis = {
                                'planning': 'üìã',
                                'development': '‚ö°',
                                'testing': 'üß™',
                                'review': 'üëÄ',
                                'completed': '‚úÖ',
                                'delivered': 'üöÄ',
                                'on-hold': '‚è∏Ô∏è',
                                'cancelled': '‚ùå'
                            };
                            
                            return `
                                <tr style="cursor: pointer;" onclick="selectProject('${project.id}')">
                                    <td>
                                        <div style="font-weight: 600;">${project.title}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">${project.description.substring(0, 50)}...</div>
                                    </td>
                                    <td>${project.clientName}</td>
                                    <td><span class="status-badge" style="background: ${statusColors[project.status]}; color: white;">${statusEmojis[project.status]} ${project.status}</span></td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="flex: 1; background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                                                <div style="width: ${project.progress}%; height: 100%; background: #10b981;"></div>
                                            </div>
                                            <span style="font-size: 0.875rem; font-weight: 500;">${project.progress}%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                                            üë• ${project.teamCount}
                                        </div>
                                    </td>
                                    <td>${project.budgetFormatted}</td>
                                    <td>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="btn btn-secondary" onclick="event.stopPropagation(); assignTeamMember('${project.id}')" title="Assigner √©quipe">üë•</button>
                                            <button class="btn btn-secondary" onclick="event.stopPropagation(); updateProjectStatus('${project.id}')" title="Modifier statut">‚úèÔ∏è</button>
                                            ${project.status === 'completed' ? `<button class="btn btn-success" onclick="event.stopPropagation(); deliverProject('${project.id}')" title="Livrer projet">üöÄ</button>` : ''}
                                            ${project.status === 'delivered' ? `<button class="btn btn-primary" onclick="event.stopPropagation(); downloadDeliverables('${project.id}')" title="T√©l√©charger livrables">üì•</button>` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">üìä Aucun projet pour le moment</td></tr>';
                    }

                    // Load clients for project creation
                    loadClientsForProjects(token);
                } else {
                    console.error('Erreur API projets:', data.message);
                }
            } catch (error) {
                console.error('Erreur chargement projets:', error);
                document.getElementById('projectsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444; padding: 2rem;">‚ùå Erreur de chargement</td></tr>';
            }
        }

        // Load statistics data
        async function loadStatisticsData(token) {
            try {
                const response = await fetch('/api/admin/statistics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    
                    // Update overview stats
                    document.getElementById('completionRate').textContent = `${stats.overview.completionRate}%`;
                    document.getElementById('averageProjectValue').textContent = `$${stats.overview.averageProjectValue.toLocaleString()}`;
                    document.getElementById('onHoldProjectsCount').textContent = stats.overview.onHoldProjects;
                    document.getElementById('totalBudget').textContent = `$${stats.overview.totalBudget.toLocaleString()}`;

                    // Update team stats table
                    const teamTbody = document.getElementById('teamStatsTableBody');
                    if (stats.teamStats.length > 0) {
                        teamTbody.innerHTML = stats.teamStats.map(member => {
                            const performance = member.completedProjects > 0 ? 
                                ((member.completedProjects / member.projectsCount) * 100).toFixed(1) : 0;
                            const performanceColor = performance >= 80 ? '#10b981' : 
                                                   performance >= 60 ? '#f59e0b' : '#ef4444';
                            
                            return `
                                <tr>
                                    <td>
                                        <div style="font-weight: 600;">${member.name}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">${member.email}</div>
                                    </td>
                                    <td>${member.projectsCount}</td>
                                    <td>${member.completedProjects}</td>
                                    <td>
                                        ${member.roles.map(role => {
                                            const roleEmojis = { dev: 'üíª', designer: 'üé®', admin: 'üõ°Ô∏è', 'project-manager': 'üìä' };
                                            return `<span style="margin-right: 0.25rem;">${roleEmojis[role] || 'üë§'}</span>`;
                                        }).join('')}
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="flex: 1; background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                                                <div style="width: ${performance}%; height: 100%; background: ${performanceColor};"></div>
                                            </div>
                                            <span style="font-size: 0.875rem; color: ${performanceColor}; font-weight: 500;">${performance}%</span>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        teamTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280; padding: 2rem;">üë• Aucune statistique d\'√©quipe</td></tr>';
                    }

                    // Update recent projects table
                    const recentTbody = document.getElementById('recentProjectsTableBody');
                    if (stats.recentProjects.length > 0) {
                        recentTbody.innerHTML = stats.recentProjects.map(project => `
                            <tr>
                                <td style="font-weight: 600;">${project.title}</td>
                                <td><span class="status-badge" style="background: ${getStatusColor(project.status)}; color: white;">${project.status}</span></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="flex: 1; background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                                            <div style="width: ${project.progress}%; height: 100%; background: #10b981;"></div>
                                        </div>
                                        <span style="font-size: 0.875rem;">${project.progress}%</span>
                                    </div>
                                </td>
                                <td>üë• ${project.teamCount}</td>
                                <td>${new Date(project.createdAt).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        recentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280; padding: 2rem;">üìÖ Aucun projet r√©cent</td></tr>';
                    }

                    // Create status chart (simple implementation)
                    drawStatusChart(stats.projectsByStatus);
                } else {
                    console.error('Erreur API statistiques:', data.message);
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'planning': '#3b82f6',
                'development': '#f59e0b',
                'testing': '#8b5cf6',
                'review': '#06b6d4',
                'completed': '#10b981',
                'on-hold': '#6b7280',
                'cancelled': '#ef4444'
            };
            return colors[status] || '#6b7280';
        }

        function drawStatusChart(projectsByStatus) {
            const canvas = document.getElementById('statusChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = Object.entries(projectsByStatus).filter(([_, count]) => count > 0);
            
            if (data.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e √† afficher', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Simple bar chart
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barWidth = canvas.width / data.length;
            const maxValue = Math.max(...data.map(([_, count]) => count));
            
            data.forEach(([status, count], index) => {
                const barHeight = (count / maxValue) * (canvas.height - 40);
                const x = index * barWidth;
                const y = canvas.height - barHeight - 20;
                
                ctx.fillStyle = getStatusColor(status);
                ctx.fillRect(x + 10, y, barWidth - 20, barHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(status.substring(0, 8), x + barWidth / 2, canvas.height - 5);
                ctx.fillText(count.toString(), x + barWidth / 2, y - 5);
            });
        }

        // Quote Management Functions
        async function loadQuotesData(token) {
            try {
                console.log('üìÑ Chargement des devis...');
                console.log('üîó URL de l\'API:', window.location.origin + '/api/admin/quotes');
                console.log('üîë Token utilis√©:', token ? 'Pr√©sent' : 'Absent');
                
                const response = await fetch('/api/admin/quotes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('üì° R√©ponse HTTP status:', response.status);
                const data = await response.json();
                console.log('üìä Donn√©es re√ßues:', data);
                
                if (data.success) {
                    window.currentQuotes = data.quotes || [];
                    console.log('üìÑ Devis charg√©s:', window.currentQuotes.length);
                    
                    // Update statistics
                    updateQuotesStats(window.currentQuotes);
                    
                    // Display quotes table
                    displayQuotes(window.currentQuotes);
                } else {
                    console.error('‚ùå Erreur chargement devis:', data.message);
                    document.getElementById('quotesTableBody').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: #666;">Erreur de chargement</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement devis:', error);
                document.getElementById('quotesTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: #666;">Erreur de connexion</td></tr>';
            }
        }

        function updateQuotesStats(quotes) {
            const total = quotes.length;
            const pending = quotes.filter(q => q.status === 'pending').length;
            const responded = quotes.filter(q => q.status === 'responded').length;
            const accepted = quotes.filter(q => q.status === 'accepted').length;
            
            document.getElementById('quotesTotalCount').textContent = total;
            document.getElementById('quotesPendingCount').textContent = pending;
            document.getElementById('quotesRespondedCount').textContent = responded;
            document.getElementById('quotesAcceptedCount').textContent = accepted;
        }

        function displayQuotes(quotes) {
            const tbody = document.getElementById('quotesTableBody');
            
            if (!quotes || quotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666; padding: 2rem;">Aucun devis re√ßu pour le moment</td></tr>';
                return;
            }
            
            tbody.innerHTML = quotes.map(quote => {
                const createdDate = new Date(quote.createdAt).toLocaleDateString('fr-FR');
                const statusColor = quote.status === 'pending' ? '#f59e0b' : 
                                  quote.status === 'responded' ? '#10b981' : 
                                  quote.status === 'accepted' ? '#059669' : '#ef4444';
                
                return `
                    <tr style="border-left: 4px solid ${statusColor};">
                        <td>
                            <div style="font-weight: 600; color: #1f2937;">${quote.client ? quote.client.name : 'Client anonyme'}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${quote.client ? quote.client.email : quote.contact}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">Devis #${quote.id}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500; color: #1f2937;">${quote.projectType}</div>
                            <div style="font-size: 0.875rem; color: #6b7280; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                 title="${quote.description}">${quote.description}</div>
                        </td>
                        <td style="font-weight: 600; color: #059669;">${quote.budget || 'Non pr√©cis√©'}</td>
                        <td>
                            <div style="font-size: 0.875rem; color: #6b7280;">${createdDate}</div>
                            <div style="font-size: 0.75rem; color: ${statusColor}; font-weight: 600;">
                                ${quote.status === 'pending' ? '‚è≥ En attente' : 
                                  quote.status === 'responded' ? '‚úÖ R√©pondu' : 
                                  quote.status === 'accepted' ? 'üéâ Accept√©' : '‚ùå Rejet√©'}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="openQuoteDetails('${quote.id}')" 
                                        style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                                    ÔøΩ Ouvrir
                                </button>
                                <button onclick="deleteQuote('${quote.id}')" 
                                        style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                                    ÔøΩÔ∏è Supprimer
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr id="response-row-${quote.id}" style="display: none; background: #f9fafb;">
                        <td colspan="5" style="padding: 1.5rem;">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div style="font-weight: bold; color: #1f2937;">üí¨ R√©ponse au client</div>
                                <textarea id="response-text-${quote.id}" rows="4" 
                                          placeholder="Tapez votre r√©ponse au client ici..."
                                          style="width: 100%; padding: 1rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;"></textarea>
                                <div style="display: flex; gap: 1rem;">
                                    <button onclick="sendResponse('${quote.id}')" 
                                            style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                        üì§ Envoyer R√©ponse
                                    </button>
                                    <button onclick="hideResponseBox('${quote.id}')" 
                                            style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                        ‚ùå Annuler
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getQuoteStatusColor(status) {
            switch(status) {
                case 'pending': return '#f59e0b';
                case 'responded': return '#3b82f6';
                case 'accepted': return '#059669';
                case 'rejected': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function getQuoteStatusText(status) {
            switch(status) {
                case 'pending': return 'En attente';
                case 'responded': return 'R√©pondu';
                case 'accepted': return 'Accept√©';
                case 'rejected': return 'Refus√©';
                default: return status;
            }
        }

        function filterQuotes() {
            const filter = document.getElementById('quotesFilter').value;
            const quotes = window.currentQuotes || [];
            
            const filteredQuotes = filter === 'all' ? quotes : quotes.filter(q => q.status === filter);
            displayQuotes(filteredQuotes);
        }

        function viewQuoteDetails(quoteId) {
            const quote = window.currentQuotes.find(q => q.id == quoteId);
            if (!quote) {
                alert('‚ùå Devis introuvable');
                return;
            }
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; color: #1f2937; font-size: 1.5rem;">üìÑ Devis #${quote.id}</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong style="color: #374151;">üë§ Contact Client</strong><br>
                                <div style="margin-top: 0.5rem;">
                                    Email: <a href="mailto:${quote.contact}" style="color: #3b82f6;">${quote.contact}</a><br>
                                    ID Client: ${quote.userId}
                                </div>
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong style="color: #374151;">üìÖ Informations</strong><br>
                                <div style="margin-top: 0.5rem;">
                                    Cr√©√© le: ${new Date(quote.createdAt).toLocaleString('fr-FR')}<br>
                                    Statut: <span style="background: ${quote.status === 'pending' ? '#fbbf24' : '#10b981'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${quote.status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #eff6ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <strong style="color: #1e40af; font-size: 1.1rem;">ÔøΩ Projet: ${quote.projectType}</strong><br>
                            <div style="margin-top: 0.5rem; color: #374151;">Service ID: ${quote.serviceId}</div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <strong style="color: #374151; font-size: 1.1rem;">üìù Description du Projet</strong>
                            <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 0.5rem; line-height: 1.6;">
                                ${quote.description}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                                <strong style="color: #92400e;">‚ö° Fonctionnalit√©s</strong><br>
                                <div style="margin-top: 0.5rem; color: #374151;">
                                    ${quote.features || 'Non sp√©cifi√©es'}
                                </div>
                            </div>
                            <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px;">
                                <strong style="color: #065f46;">‚è∞ D√©lai</strong><br>
                                <div style="margin-top: 0.5rem; color: #374151;">
                                    ${quote.timeline || 'Non sp√©cifi√©'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <strong style="color: #991b1b;">üí∞ Budget Demand√©</strong><br>
                            <div style="margin-top: 0.5rem; font-size: 1.2rem; font-weight: bold; color: #374151;">
                                ${quote.budget || 'Budget non sp√©cifi√©'}
                            </div>
                        </div>
                        
                        ${quote.adminResponse ? `
                            <div style="margin-bottom: 1.5rem; background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #059669;">
                                <strong style="color: #065f46; font-size: 1.1rem;">üí¨ Votre R√©ponse</strong><br>
                                <div style="margin-top: 1rem; line-height: 1.6; color: #374151;">
                                    ${quote.adminResponse.message || 'Aucune r√©ponse encore'}
                                </div>
                                ${quote.adminResponse.respondedAt ? `
                                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                                        Envoy√© le: ${new Date(quote.adminResponse.respondedAt).toLocaleString('fr-FR')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; gap: 1rem;">
                                ${quote.status === 'pending' ? 
                                    `<button onclick="openResponseModal('${quote.id}'); this.closest('[style*=\"position: fixed\"]').remove();" 
                                             style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                        üí¨ R√©pondre au Client
                                    </button>` : ''
                                }
                                <button onclick="deleteQuote('${quote.id}'); this.closest('[style*=\"position: fixed\"]').remove();" 
                                        style="padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    üóëÔ∏è Supprimer
                                </button>
                                ${quote.status === 'responded' ? 
                                    `<button onclick="acceptQuote('${quote.id}'); this.closest('[style*=\"position: fixed\"]').remove();" 
                                             style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                        ‚úÖ Accepter
                                    </button>
                                    <button onclick="rejectQuote('${quote.id}'); this.closest('[style*=\"position: fixed\"]').remove();" 
                                             style="padding: 0.75rem 1.5rem; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                        ‚ùå Rejeter
                                    </button>` : ''
                                }
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                                    style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‚ùå Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // NOUVELLES FONCTIONS SIMPLIFI√âES

        // Ouvrir les d√©tails d'un devis dans un modal simple
        function openQuoteDetails(quoteId) {
            const quote = window.currentQuotes.find(q => q.id == quoteId);
            if (!quote) {
                alert('‚ùå Devis introuvable');
                return;
            }
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #1f2937;">üìÑ Devis #${quote.id}</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem;">‚úï</button>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üë§ Informations Client</h3>
                            <div><strong>Nom :</strong> ${quote.client ? quote.client.name : 'Non renseign√©'}</div>
                            <div><strong>Email :</strong> ${quote.client ? quote.client.email : quote.contact}</div>
                            <div><strong>T√©l√©phone :</strong> ${quote.client ? quote.client.phone : 'Non renseign√©'}</div>
                            <div><strong>Date de demande :</strong> ${new Date(quote.createdAt).toLocaleString('fr-FR')}</div>
                        </div>
                        
                        <div style="background: #eff6ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #1e40af;">üöÄ Projet Demand√©</h3>
                            <div><strong>Type :</strong> ${quote.projectType}</div>
                            <div style="margin-top: 1rem;"><strong>Description :</strong></div>
                            <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 0.5rem; line-height: 1.6;">
                                ${quote.description}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                                <strong>‚ö° Fonctionnalit√©s</strong><br>
                                <div style="margin-top: 0.5rem;">${quote.features || 'Non sp√©cifi√©es'}</div>
                            </div>
                            <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px;">
                                <strong>‚è∞ D√©lai souhait√©</strong><br>
                                <div style="margin-top: 0.5rem;">${quote.timeline || 'Non sp√©cifi√©'}</div>
                            </div>
                        </div>
                        
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center;">
                            <strong style="color: #991b1b; font-size: 1.2rem;">üí∞ Budget : ${quote.budget || 'Non pr√©cis√©'}</strong>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #065f46;">üí¨ Votre R√©ponse</h3>
                            <textarea id="modal-response-${quote.id}" rows="5" 
                                      placeholder="Tapez votre r√©ponse d√©taill√©e au client ici..."
                                      style="width: 100%; padding: 1rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                <button onclick="sendModalResponse('${quote.id}')" 
                                        style="flex: 1; padding: 1rem; background: #059669; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                                    üì§ Envoyer R√©ponse
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: space-between;">
                            <button onclick="deleteQuoteAndClose('${quote.id}')" 
                                    style="padding: 1rem 2rem; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                üóëÔ∏è Supprimer ce Devis
                            </button>
                            <button onclick="closeModal()" 
                                    style="padding: 1rem 2rem; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‚úÖ Fermer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Envoyer une r√©ponse depuis le modal
        function sendModalResponse(quoteId) {
            const responseText = document.getElementById(`modal-response-${quoteId}`).value.trim();
            
            if (!responseText) {
                alert('‚ùå Veuillez taper votre r√©ponse avant d\'envoyer');
                return;
            }
            
            sendQuoteResponse(quoteId, responseText);
        }

        // Afficher la zone de r√©ponse dans le tableau
        function showResponseBox(quoteId) {
            document.getElementById(`response-row-${quoteId}`).style.display = 'table-row';
        }

        // Masquer la zone de r√©ponse
        function hideResponseBox(quoteId) {
            document.getElementById(`response-row-${quoteId}`).style.display = 'none';
        }

        // Envoyer une r√©ponse
        function sendResponse(quoteId) {
            const responseText = document.getElementById(`response-text-${quoteId}`).value.trim();
            
            if (!responseText) {
                alert('‚ùå Veuillez taper votre r√©ponse avant d\'envoyer');
                return;
            }
            
            sendQuoteResponse(quoteId, responseText);
        }

        // Fonction principale pour envoyer la r√©ponse
        async function sendQuoteResponse(quoteId, responseMessage) {
            try {
                console.log('üì§ Envoi de la r√©ponse...', { quoteId, message: responseMessage });
                
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    alert('‚ùå Vous devez √™tre connect√© pour r√©pondre');
                    return;
                }
                
                const requestData = {
                    proposedAmount: '√Ä discuter',
                    estimatedTime: '√Ä d√©finir selon le projet',
                    message: responseMessage.trim(),
                    terms: 'Conditions standard MiaTech'
                };
                
                console.log('üì° Donn√©es envoy√©es:', requestData);
                
                const response = await fetch(`/api/admin/quotes/${quoteId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üîÑ Status de la r√©ponse:', response.status);
                
                const result = await response.json();
                console.log('üìä R√©sultat re√ßu:', result);
                
                if (response.ok && result.success) {
                    alert('‚úÖ R√©ponse envoy√©e avec succ√®s au client !\n\nLe client recevra votre message par email.');
                    // Fermer les modals et zones de r√©ponse
                    const modal = document.querySelector('[style*="position: fixed"]');
                    if (modal) modal.remove();
                    hideResponseBox(quoteId);
                    // Recharger les devis
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur lors de l\'envoi: ' + (result.message || 'Erreur inconnue'));
                    console.error('Erreur serveur:', result);
                }
                
            } catch (error) {
                console.error('Erreur envoi r√©ponse:', error);
                alert('‚ùå Erreur technique: ' + error.message + '\n\nV√©rifiez la console pour plus de d√©tails.');
            }
        }

        // Fonctions utilitaires pour les modals
        function closeModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        async function deleteQuoteAndClose(quoteId) {
            console.log('üóëÔ∏è deleteQuoteAndClose appel√©e avec ID:', quoteId);
            
            if (!quoteId) {
                alert('‚ùå ID du devis manquant');
                return;
            }
            
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce devis d√©finitivement ?')) {
                try {
                    const success = await deleteQuote(quoteId);
                    if (success) {
                        console.log('‚úÖ Suppression r√©ussie, fermeture modal');
                        closeModal();
                    } else {
                        console.log('‚ùå Suppression √©chou√©e');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur dans deleteQuoteAndClose:', error);
                    alert('‚ùå Erreur lors de la suppression: ' + error.message);
                }
            }
        }

        // Nouvelle fonction pour ouvrir le modal de r√©ponse
        function openResponseModal(quoteId) {
            const quote = window.currentQuotes.find(q => q.id == quoteId);
            if (!quote) {
                alert('‚ùå Devis introuvable');
                return;
            }
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #1f2937; font-size: 1.5rem;">üí¨ R√©pondre au Devis #${quote.id}</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #374151;">üìã R√©sum√© du Projet</h3>
                            <div style="margin-bottom: 0.5rem;"><strong>Projet:</strong> ${quote.projectType}</div>
                            <div style="margin-bottom: 0.5rem;"><strong>Budget demand√©:</strong> ${quote.budget}</div>
                            <div style="margin-bottom: 0.5rem;"><strong>D√©lai souhait√©:</strong> ${quote.timeline}</div>
                            <div><strong>Contact:</strong> ${quote.contact}</div>
                        </div>
                        
                        <form id="responseForm-${quote.id}" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151;">üí∞ Votre Devis (Prix propos√©)</label>
                                <input type="text" id="proposedPrice-${quote.id}" placeholder="Ex: 15000‚Ç¨" required
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151;">‚è∞ D√©lai de R√©alisation</label>
                                <input type="text" id="estimatedTime-${quote.id}" placeholder="Ex: 6-8 semaines" required
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151;">üìù Votre Message au Client</label>
                                <textarea id="responseMessage-${quote.id}" rows="6" required
                                          placeholder="Bonjour,&#10;&#10;Merci pour votre demande de devis. Apr√®s analyse de vos besoins, voici notre proposition...&#10;&#10;Cordialement,&#10;L'√©quipe MiaTech"
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151;">üìã Conditions et Termes (Optionnel)</label>
                                <textarea id="terms-${quote.id}" rows="4"
                                          placeholder="- Acompte de 30% √† la signature&#10;- Livraison par phases&#10;- Support inclus pendant 3 mois&#10;- ..."
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                                <button type="button" onclick="sendQuoteResponse('${quote.id}')" 
                                        style="flex: 1; padding: 1rem; background: #059669; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                                    üì§ Envoyer la R√©ponse
                                </button>
                                <button type="button" onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                                        style="padding: 1rem; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    ‚ùå Annuler
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function respondToQuote(quoteId) {
            const quote = window.currentQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üí¨ R√©pondre au Devis #${quote.id}</h3>
                        
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                            <strong>Client:</strong> ${quote.client.name}<br>
                            <strong>Service:</strong> ${quote.service}<br>
                            <strong>Budget client:</strong> $${quote.budget || 'Non sp√©cifi√©'}
                        </div>
                        
                        <form id="quoteResponseForm">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üí∞ Montant propos√© ($)</label>
                                <input type="number" id="proposedAmount" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" 
                                       placeholder="Ex: 1500">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">‚è±Ô∏è D√©lai estim√©</label>
                                <input type="text" id="estimatedTime" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" 
                                       placeholder="Ex: 2-3 semaines">
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìù Conditions et d√©tails</label>
                                <textarea id="responseTerms" required rows="6" 
                                          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;" 
                                          placeholder="D√©crivez les conditions, les livrables, le processus de paiement, etc.">Bonjour ${quote.client.name},

Merci pour votre demande de devis pour ${quote.service}.

Apr√®s analyse de vos besoins, nous sommes ravis de vous proposer notre solution.

Ce devis inclut:
- [Listez les livrables]
- Support technique inclus
- R√©visions comprises dans le prix

Conditions de paiement:
- 50% √† la commande
- 50% √† la livraison

N'h√©sitez pas si vous avez des questions !

Cordialement,
L'√©quipe MiaTech</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                                        style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px;">
                                    Annuler
                                </button>
                                <button type="submit" 
                                        style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px;">
                                    üì§ Envoyer la R√©ponse
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('quoteResponseForm').onsubmit = async (e) => {
                e.preventDefault();
                await submitQuoteResponse(quoteId, modal);
            };
        }

        async function submitQuoteResponse(quoteId, modal) {
            try {
                const responseData = {
                    proposedAmount: document.getElementById('proposedAmount').value,
                    estimatedTime: document.getElementById('estimatedTime').value,
                    terms: document.getElementById('responseTerms').value
                };
                
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(responseData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    modal.remove();
                    alert('‚úÖ R√©ponse envoy√©e avec succ√®s !');
                    // Reload quotes data
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur lors de l\'envoi: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur envoi r√©ponse:', error);
                alert('‚ùå Erreur lors de l\'envoi de la r√©ponse');
            }
        }

        async function updateQuoteStatus(quoteId, currentStatus) {
            const statuses = [
                { value: 'pending', label: 'En attente' },
                { value: 'responded', label: 'R√©pondu' },
                { value: 'accepted', label: 'Accept√©' },
                { value: 'rejected', label: 'Refus√©' }
            ];
            
            const newStatus = prompt(
                `Statut actuel: ${getQuoteStatusText(currentStatus)}\n\n` +
                'Nouveau statut:\n' +
                statuses.map(s => `${s.value} - ${s.label}`).join('\n') +
                '\n\nEntrez le nouveau statut:'
            );
            
            if (!newStatus || !statuses.find(s => s.value === newStatus)) {
                if (newStatus) alert('‚ùå Statut invalide');
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Statut mis √† jour !');
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur mise √† jour statut:', error);
                alert('‚ùå Erreur lors de la mise √† jour');
            }
        }

        // Envoyer un accus√© de r√©ception
        async function sendAcknowledgment(quoteId) {
            const quote = window.currentQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const message = prompt(
                `Accus√© de r√©ception pour ${quote.client.name}\n\n` +
                'Message d\'accus√© de r√©ception:',
                `Bonjour ${quote.client.name},\n\nNous avons bien re√ßu votre demande de devis pour "${quote.service}".\n\nNotre √©quipe analyse actuellement votre projet et vous enverra une r√©ponse d√©taill√©e sous 48h maximum.\n\nMerci pour votre confiance !\n\nCordialement,\nL'√©quipe MiaTech`
            );
            
            if (!message) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/acknowledge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Accus√© de r√©ception envoy√© !');
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur envoi accus√©:', error);
                alert('‚ùå Erreur lors de l\'envoi de l\'accus√© de r√©ception');
            }
        }

        // Fonction pour envoyer la r√©ponse au devis
        async function sendQuoteResponse(quoteId) {
            try {
                const proposedPrice = document.getElementById(`proposedPrice-${quoteId}`).value;
                const estimatedTime = document.getElementById(`estimatedTime-${quoteId}`).value;
                const responseMessage = document.getElementById(`responseMessage-${quoteId}`).value;
                const terms = document.getElementById(`terms-${quoteId}`).value;
                
                // Validation
                if (!proposedPrice || !estimatedTime || !responseMessage) {
                    alert('‚ùå Veuillez remplir tous les champs obligatoires');
                    return;
                }
                
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        proposedAmount: proposedPrice,
                        estimatedTime: estimatedTime,
                        message: responseMessage,
                        terms: terms || 'Conditions standard'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ R√©ponse envoy√©e avec succ√®s !');
                    // Fermer le modal
                    document.querySelector('[style*="position: fixed"]').remove();
                    // Recharger les devis
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
                
            } catch (error) {
                console.error('Erreur envoi r√©ponse:', error);
                alert('‚ùå Erreur technique: ' + error.message);
            }
        }

        // Fonction pour supprimer un devis
        async function deleteQuote(quoteId) {
            try {
                console.log('üóëÔ∏è Suppression du devis:', quoteId);
                
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    alert('‚ùå Vous devez √™tre connect√© pour supprimer');
                    return false;
                }
                
                console.log('üì° Envoi requ√™te DELETE...');
                const response = await fetch(`/api/admin/quotes/${quoteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üîÑ Status r√©ponse:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur HTTP:', response.status, errorText);
                    alert(`‚ùå Erreur serveur (${response.status}): ${errorText}`);
                    return false;
                }
                
                const result = await response.json();
                console.log('üìä R√©sultat suppression:', result);
                
                if (result.success) {
                    alert('‚úÖ Devis supprim√© avec succ√®s !');
                    // Recharger les devis
                    await loadQuotesData(token);
                    return true;
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Erreur suppression:', error);
                alert('‚ùå Erreur technique: ' + error.message + '\n\nV√©rifiez la console pour plus de d√©tails.');
                return false;
            }
        }

        // Accepter un devis
        async function acceptQuote(quoteId) {
            const quote = window.currentQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const confirmText = `Confirmer l'acceptation du devis pour ${quote.client.name} ?\n\n` +
                `Service: ${quote.service}\n` +
                `Montant: $${quote.adminResponse?.proposedAmount || 'N/A'}\n` +
                `D√©lai: ${quote.adminResponse?.estimatedTime || 'N/A'}`;
            
            if (!confirm(confirmText)) return;
            
            const clientNotes = prompt('Notes du client (optionnel):', 'Devis accept√©. Merci pour votre professionnalisme !');
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ clientNotes })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('üéâ Devis accept√© avec succ√®s !');
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur acceptation devis:', error);
                alert('‚ùå Erreur lors de l\'acceptation du devis');
            }
        }

        // Rejeter un devis
        async function rejectQuote(quoteId) {
            const quote = window.currentQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const reasons = [
                'Budget insuffisant',
                'D√©lais trop longs', 
                'Besoin diff√©rent',
                'Trouv√© ailleurs',
                'Projet annul√©',
                'Autre'
            ];
            
            const reasonIndex = prompt(
                `Raison du rejet du devis pour ${quote.client.name}:\n\n` +
                reasons.map((r, i) => `${i + 1}. ${r}`).join('\n') +
                '\n\nChoisissez un num√©ro (1-6):'
            );
            
            const reasonNum = parseInt(reasonIndex);
            if (!reasonNum || reasonNum < 1 || reasonNum > 6) {
                alert('‚ùå Choix invalide');
                return;
            }
            
            let rejectionReason = reasons[reasonNum - 1];
            if (rejectionReason === 'Autre') {
                rejectionReason = prompt('Pr√©cisez la raison:') || 'Autre';
            }
            
            const clientNotes = prompt('Notes additionnelles (optionnel):');
            
            if (!confirm(`Confirmer le rejet du devis ?\nRaison: ${rejectionReason}`)) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ rejectionReason, clientNotes })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('üìù Devis rejet√© et archiv√©');
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur rejet devis:', error);
                alert('‚ùå Erreur lors du rejet du devis');
            }
        }

        // Voir l'historique complet d'un devis
        async function viewQuoteHistory(quoteId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/quotes/${quoteId}/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert('‚ùå Erreur: ' + data.message);
                    return;
                }
                
                const { quote, history } = data;
                
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üìú Historique du Devis #${quote.id}</h3>
                            
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                                <strong>üë§ Client:</strong> ${quote.client.name} (${quote.client.email})<br>
                                <strong>üîß Service:</strong> ${quote.service}<br>
                                <strong>üí∞ Budget:</strong> $${quote.budget}<br>
                                <strong>üìä Statut actuel:</strong> <span style="color: ${getQuoteStatusColor(quote.status)}; font-weight: 600;">${getQuoteStatusText(quote.status)}</span>
                            </div>
                            
                            <h4 style="color: #1f2937; margin-bottom: 1rem;">üïê Chronologie des √©v√©nements</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${history.map(event => `
                                    <div style="display: flex; align-items: start; gap: 1rem; padding: 0.75rem; border-left: 4px solid ${getEventColor(event.action)}; background: ${getEventBg(event.action)}; margin-bottom: 0.5rem; border-radius: 6px;">
                                        <div style="font-size: 1.25rem;">${getEventIcon(event.action)}</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1f2937;">
                                                ${getEventTitle(event.action)} 
                                                <span style="font-weight: normal; color: #6b7280;">par ${event.actorName}</span>
                                            </div>
                                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">
                                                ${new Date(event.timestamp).toLocaleString('fr-FR')}
                                            </div>
                                            <div style="color: #374151;">${event.details}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                                        style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px;">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Erreur historique:', error);
                alert('‚ùå Erreur lors du chargement de l\'historique');
            }
        }

        // Fonctions utilitaires pour l'historique
        function getEventColor(action) {
            switch(action) {
                case 'created': return '#3b82f6';
                case 'acknowledged': return '#8b5cf6';
                case 'responded': return '#059669';
                case 'accepted': return '#10b981';
                case 'rejected': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function getEventBg(action) {
            switch(action) {
                case 'created': return '#eff6ff';
                case 'acknowledged': return '#f3e8ff';
                case 'responded': return '#ecfdf5';
                case 'accepted': return '#d1fae5';
                case 'rejected': return '#fef2f2';
                default: return '#f9fafb';
            }
        }

        function getEventIcon(action) {
            switch(action) {
                case 'created': return 'üìù';
                case 'acknowledged': return 'üìß';
                case 'responded': return 'üí¨';
                case 'accepted': return '‚úÖ';
                case 'rejected': return '‚ùå';
                default: return 'üìã';
            }
        }

        function getEventTitle(action) {
            switch(action) {
                case 'created': return 'Devis cr√©√©';
                case 'acknowledged': return 'Accus√© de r√©ception envoy√©';
                case 'responded': return 'Devis r√©pondu';
                case 'accepted': return 'Devis accept√©';
                case 'rejected': return 'Devis rejet√©';
                default: return action;
            }
        }

        // Project management functions
        function showCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'block';
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'none';
            document.getElementById('createProjectForm').reset();
        }

        // Load clients for project creation
        async function loadClientsForProjects(token) {
            try {
                const response = await fetch('/api/admin/all-clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('projectClient');
                    select.innerHTML = '<option value="">S√©lectionner un client</option>' +
                        data.clients.map(client => `<option value="${client.id}">${client.name} (${client.email})</option>`).join('');
                }
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
        }

        // Create project form handler
        document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('adminToken');
            
            const projectData = {
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                clientId: document.getElementById('projectClient').value,
                budget: document.getElementById('projectBudget').value,
                deadline: document.getElementById('projectDeadline').value,
                priority: document.getElementById('projectPriority').value
            };
            
            try {
                const response = await fetch('/api/admin/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });
                
                const result = await response.json();
                if (result.success) {
                    closeCreateProjectModal();
                    await loadProjectsData(token);
                    alert('‚úÖ Projet cr√©√© avec succ√®s !');
                } else {
                    alert('‚ùå Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur cr√©ation projet:', error);
                alert('‚ùå Erreur lors de la cr√©ation du projet');
            }
        });

        function selectProject(projectId) {
            // Highlight selected project and show assignment panel
            const rows = document.querySelectorAll('#projectsTableBody tr');
            rows.forEach(row => row.style.backgroundColor = '');
            event.target.closest('tr').style.backgroundColor = '#f3f4f6';
            
            // Show assignment panel (simplified)
            document.getElementById('projectAssignmentPanel').innerHTML = `
                <h4>üéØ Projet s√©lectionn√©: ${projectId}</h4>
                <p>Fonctionnalit√©s d'attribution d'√©quipe √† venir...</p>
                <button class="btn btn-primary" onclick="assignTeamMember('${projectId}')">üë• G√©rer l'√©quipe</button>
            `;
        }

        function assignTeamMember(projectId) {
            alert(`üöß Fonction d'attribution d'√©quipe √† impl√©menter pour le projet ${projectId}`);
        }

        function updateProjectStatus(projectId) {
            const newStatus = prompt('Nouveau statut (planning, development, testing, review, completed, on-hold, cancelled):');
            if (newStatus) {
                const progress = prompt('Nouveau pourcentage de progression (0-100):');
                // Implementation √† compl√©ter
                alert(`üöß Mise √† jour du statut √† impl√©menter: ${newStatus} - ${progress}%`);
            }
        }

        // Livrer un projet
        async function deliverProject(projectId) {
            const deliveryModal = document.createElement('div');
            deliveryModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üöÄ Livrer le Projet</h3>
                        
                        <form id="deliveryForm">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìé Fichiers Livrables</label>
                                <div id="deliverablesContainer">
                                    <div class="deliverable-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="text" placeholder="Nom du fichier" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                        <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                            <option value="document">üìÑ Document</option>
                                            <option value="design">üé® Design</option>
                                            <option value="code">üíª Code</option>
                                            <option value="other">üìé Autre</option>
                                        </select>
                                        <input type="text" placeholder="URL du fichier" style="flex: 2; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                        <button type="button" onclick="removeDeliverable(this)" style="padding: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px;">‚ùå</button>
                                    </div>
                                </div>
                                <button type="button" onclick="addDeliverable()" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 4px; margin-top: 0.5rem;">‚ûï Ajouter Fichier</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìù Notes de Livraison</label>
                                <textarea id="deliveryNotes" placeholder="Instructions, mots de passe, notes importantes..." style="width: 100%; height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üí¨ Message au Client</label>
                                <textarea id="clientMessage" placeholder="Message personnel pour le client..." style="width: 100%; height: 100px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;">üéâ F√©licitations ! Votre projet est maintenant termin√© et livr√©. Vous trouverez tous les fichiers finaux ci-dessous. Merci pour votre confiance !</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeDeliveryModal()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px;">Annuler</button>
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px;">üöÄ Livrer Projet</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deliveryModal);
            
            // Handle form submission
            document.getElementById('deliveryForm').onsubmit = async (e) => {
                e.preventDefault();
                await submitDelivery(projectId);
            };
        }

        function addDeliverable() {
            const container = document.getElementById('deliverablesContainer');
            const newItem = document.createElement('div');
            newItem.className = 'deliverable-item';
            newItem.style = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            newItem.innerHTML = `
                <input type="text" placeholder="Nom du fichier" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <select style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="document">üìÑ Document</option>
                    <option value="design">üé® Design</option>
                    <option value="code">üíª Code</option>
                    <option value="other">üìé Autre</option>
                </select>
                <input type="text" placeholder="URL du fichier" style="flex: 2; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                <button type="button" onclick="removeDeliverable(this)" style="padding: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px;">‚ùå</button>
            `;
            container.appendChild(newItem);
        }

        function removeDeliverable(button) {
            button.parentElement.remove();
        }

        async function submitDelivery(projectId) {
            try {
                const deliverableItems = document.querySelectorAll('.deliverable-item');
                const deliverables = Array.from(deliverableItems).map(item => {
                    const inputs = item.querySelectorAll('input');
                    const select = item.querySelector('select');
                    return {
                        name: inputs[0].value,
                        type: select.value,
                        url: inputs[1].value || '#',
                        description: `Fichier ${select.options[select.selectedIndex].text.split(' ')[1]}`
                    };
                }).filter(d => d.name.trim());

                const deliveryData = {
                    deliverables: deliverables,
                    deliveryNotes: document.getElementById('deliveryNotes').value,
                    clientMessage: document.getElementById('clientMessage').value
                };

                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/projects/${projectId}/delivery`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(deliveryData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`üöÄ Projet livr√© avec succ√®s! ${deliverables.length} fichiers livr√©s.`);
                    closeDeliveryModal();
                    
                    // Envoyer email de notification
                    await sendDeliveryEmail(projectId);
                    
                    // Recharger les donn√©es
                    loadProjectsData(token);
                } else {
                    alert('‚ùå Erreur lors de la livraison: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la livraison du projet');
            }
        }

        async function sendDeliveryEmail(projectId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/projects/${projectId}/send-delivery-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.log('üìß Email de livraison envoy√©:', result);
                } else {
                    console.error('Erreur envoi email:', result.message);
                }
            } catch (error) {
                console.error('Erreur envoi email:', error);
            }
        }

        function closeDeliveryModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        // T√©l√©charger les livrables
        async function downloadDeliverables(projectId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/projects/${projectId}/download-all`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Afficher les informations de t√©l√©chargement
                    const downloadModal = document.createElement('div');
                    downloadModal.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                                <h3 style="margin: 0 0 1.5rem 0; color: #1f2937;">üì• ${result.projectTitle}</h3>
                                <p><strong>üìÖ Date de livraison:</strong> ${result.deliveryDate}</p>
                                <p><strong>üìÅ Fichiers disponibles:</strong> ${result.downloadInfo.totalFiles}</p>
                                
                                ${result.deliveryNotes ? `<p><strong>üìù Notes:</strong><br>${result.deliveryNotes}</p>` : ''}
                                
                                <h4>üìé Livrables:</h4>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem;">
                                    ${result.deliverables.map(file => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6;">
                                            <span>${file.name}</span>
                                            <a href="${file.url}" target="_blank" style="color: #3b82f6; text-decoration: none;">üì• T√©l√©charger</a>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px;">Fermer</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(downloadModal);
                } else {
                    alert('‚ùå Erreur lors du t√©l√©chargement: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors du t√©l√©chargement');
            }
        }

        // Test Quote Creation Function
        async function testCreateQuote() {
            try {
                console.log('üß™ Test de cr√©ation de devis...');
                const testQuote = {
                    userId: 1,
                    serviceId: 1,
                    projectType: 'Site Web Test',
                    description: 'Devis de test pour v√©rifier le syst√®me',
                    features: 'Fonctionnalit√©s de test',
                    timeline: '2 semaines',
                    budget: '5000‚Ç¨',
                    contact: 'test@miatech.com'
                };

                const response = await fetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testQuote)
                });

                const result = await response.json();
                console.log('üìã R√©sultat cr√©ation devis:', result);
                
                if (response.ok) {
                    alert('‚úÖ Devis de test cr√©√© avec succ√®s !');
                    // Recharger les devis
                    const token = localStorage.getItem('adminToken');
                    await loadQuotesData(token);
                } else {
                    alert('‚ùå Erreur cr√©ation devis: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Erreur test cr√©ation:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Make test function available globally
        window.testCreateQuote = testCreateQuote;

        // ========================
        // SYST√àME DE NOTIFICATIONS
        // ========================
        
        let notificationsData = null;
        let notificationsInterval = null;
        
        // Charger les notifications
        async function loadNotifications() {
            try {
                console.log('üì¢ Chargement des notifications...');
                
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    notificationsData = data;
                    updateNotificationBadge(data.summary.total);
                    updateNotificationsList(data.notifications);
                    updateLastUpdateTime();
                    
                    // Mettre √† jour aussi le badge des messages dans la sidebar
                    updateSidebarMessagesBadge(data.summary.unreadMessages);
                    
                    console.log('‚úÖ Notifications mises √† jour:', data.summary);
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement notifications:', error);
            }
        }
        
        // Mettre √† jour le badge de notification
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Mettre √† jour le badge des messages dans la sidebar
        function updateSidebarMessagesBadge(unreadCount) {
            const badge = document.getElementById('messagesBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
                console.log('üîî Badge sidebar messages mis √† jour:', unreadCount);
            }
        }
        
        // Mettre √† jour la liste des notifications
        function updateNotificationsList(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div class="notifications-empty">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                        Aucune notification en attente
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.priority}-priority" onclick="handleNotificationClick('${notification.type}')">
                    <div class="notification-icon">${notification.icon}</div>
                    <div class="notification-content">
                        <div class="notification-title">
                            ${notification.title}
                            ${notification.count > 0 ? 
                                `<span class="notification-count has-items">${notification.count}</span>` :
                                `<span class="notification-count">${notification.count}</span>`
                            }
                        </div>
                        <div class="notification-description">${notification.description}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Mettre √† jour l'heure de derni√®re mise √† jour
        function updateLastUpdateTime() {
            const timeElement = document.getElementById('lastUpdateTime');
            const now = new Date();
            timeElement.textContent = `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
        }
        
        // G√©rer le clic sur une notification
        function handleNotificationClick(type) {
            console.log('üîî Clic notification:', type);
            
            // Fermer le dropdown
            document.getElementById('notificationsDropdown').style.display = 'none';
            
            // Naviguer vers la section correspondante
            switch(type) {
                case 'messages':
                    showSection('messages');
                    break;
                case 'quotes':
                    showSection('quotes'); 
                    break;
                case 'orders':
                    showSection('orders');
                    break;
                case 'activity':
                    showSection('users');
                    break;
            }
        }
        
        // Basculer l'affichage du dropdown de notifications
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                // Rafra√Æchir les notifications √† l'ouverture
                loadNotifications();
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Marquer tous les messages comme lus
        async function markAllAsRead() {
            try {
                console.log('üìß Marquage tous messages comme lus...');
                
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/messages/read-all', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Messages marqu√©s comme lus:', data.count);
                    alert(`‚úÖ ${data.message}`);
                    // Rafra√Æchir les notifications
                    loadNotifications();
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur marquage messages lus:', error);
                alert('‚ùå Erreur lors du marquage des messages');
            }
        }
        
        // Fermer le dropdown si on clique ailleurs
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationsDropdown');
            const bell = event.target.closest('.notifications-bell');
            
            if (!bell && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // D√©marrer le syst√®me de notifications
        function initNotifications() {
            // Charger imm√©diatement
            loadNotifications();
            
            // Mettre √† jour toutes les 30 secondes
            notificationsInterval = setInterval(loadNotifications, 30000);
        }
        
        // Arr√™ter le syst√®me de notifications
        function stopNotifications() {
            if (notificationsInterval) {
                clearInterval(notificationsInterval);
                notificationsInterval = null;
            }
        }

        // Auto refresh all sections every 30 seconds
        setInterval(() => {
            if (currentSection === 'dashboard') {
                loadDashboardData();
            } else {
                loadSectionData(currentSection);
            }
        }, 30000);
    </script>
</body>
</html>